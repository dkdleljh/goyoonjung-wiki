#!/usr/bin/env python3
"""Generate System Status Dashboard.
- Output: pages/system_status.md
- Metrics:
  - Total URLs tracked (DB)
  - Last Update Time
  - Broken Links Count
  - Recent News Count
"""

import os
import sqlite3
from datetime import datetime
from pathlib import Path

BASE = Path(__file__).resolve().parent.parent
DB_PATH = BASE / 'data' / 'wiki.db'
DASHBOARD_MD = BASE / 'pages' / 'system_status.md'
NEWS_DIR = BASE / 'news'

def get_db_stats():
    if not DB_PATH.exists():
        return {"urls": 0}

    try:
        conn = sqlite3.connect(DB_PATH)
        c = conn.cursor()
        c.execute("SELECT count(*) FROM seen_urls")
        count = c.fetchone()[0]
        conn.close()
        return {"urls": count}
    except (sqlite3.Error, OSError):
        return {"urls": "Error"}

def get_last_run_status():
    # Check today's news log (Asia/Seoul)
    today = datetime.now().astimezone().strftime("%Y-%m-%d")
    log_path = NEWS_DIR / f"{today}.md"

    if not log_path.exists():
        return "Not Run Yet", "Gray"

    content = log_path.read_text(encoding="utf-8")

    # We standardize on:
    # - ê²°ê³¼: ì„±ê³µ|ì§„í–‰ì¤‘|ë¶€ë¶„ì„±ê³µ|ì‹¤íŒ¨
    # (line starts with '- ê²°ê³¼:')
    import re

    if re.search(r"^- ê²°ê³¼:\s*ì„±ê³µ\s*$", content, flags=re.M):
        return "Success", "Green"
    if re.search(r"^- ê²°ê³¼:\s*ì‹¤íŒ¨\s*$", content, flags=re.M):
        return "Fail", "Red"
    if re.search(r"^- ê²°ê³¼:\s*ë¶€ë¶„ì„±ê³µ\s*$", content, flags=re.M):
        return "Partial", "Yellow"
    if re.search(r"^- ê²°ê³¼:\s*ì§„í–‰ì¤‘\s*$", content, flags=re.M):
        return "Running", "Yellow"

    return "Running/Unknown", "Yellow"

def main():
    db_stats = get_db_stats()
    run_status, run_color = get_last_run_status()
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # Markdown Dashboard
    dashboard = f"""# ðŸ–¥ï¸ System Status Dashboard
> Last Refreshed: {now}

## ðŸš¦ Automation Health
| Metric | Status | Note |
| :--- | :--- | :--- |
| **Daily Update** | **{run_status}** | Check `news/` for details |
| **Database** | {db_stats['urls']} URLs | `wiki.db` size: {os.path.getsize(DB_PATH) if DB_PATH.exists() else 0} bytes |
| **Config** | Active | `config.yaml` loaded |

## ðŸ“Š Modules
- **News Collector**: Active (Google RSS)
- **Schedule Estimator**: Active
- **Profile Updater**: Active (Context Aware)
- **Visuals**: Active (Mermaid Timeline)

## ðŸ”— Quick Actions
- [View Daily Log](../news/)
- [View Timeline](timeline.md)
- [View Link Health](link-health.md)

---
*Generated by scripts/update_dashboard.py*
"""

    DASHBOARD_MD.write_text(dashboard, encoding='utf-8')
    print(f"Updated Dashboard: {DASHBOARD_MD}")

if __name__ == "__main__":
    main()
